[opcache]
; ========================================
; OPcache 开发环境配置
; 目标: 优化性能,适用于 php artisan serve 模式
; ========================================

; 加载 OPcache 扩展 (如果基础镜像已加载,则可注释掉此行)
zend_extension=opcache

; 启用 OPcache (生产环境必须开启)
opcache.enable=1

; CLI 模式下也启用 OPcache (适用于 artisan 命令)
opcache.enable_cli=1

; ========================================
; JIT 编译器配置 (PHP 8.0+)
; ========================================
; JIT (Just-In-Time) 编译器可以进一步提升性能
; opcache.jit=1205 表示启用 JIT,数字控制优化级别
; opcache.jit_buffer_size=256M 表示 JIT 缓冲区大小
; 注意: JIT 在某些场景下可能导致性能下降,建议测试后再启用
;opcache.jit=1205
;opcache.jit_buffer_size=256M

; ========================================
; 文件缓存配置 (警告: 与 artisan serve 不兼容!)
; ========================================
; opcache.file_cache=/tmp/opcache
; 文件缓存目录 - 编译后的 opcode 保存到文件系统
; 作用: 可以在 Docker 重启后保留缓存,加速启动
; 注意: 在 php artisan serve 模式下会导致服务崩溃!
; 如需使用文件缓存,请改用 PHP-FPM + Nginx 或 Laravel Octane
;opcache.file_cache=/tmp/opcache

; opcache.file_cache_only=1
; 仅使用文件缓存,不使用共享内存缓存
; = 1 表示编译后的 opcode 只保存到文件,不放内存
; 优点: 避免每次都从 Windows 文件系统读取源文件
; 缺点: 与 artisan serve 不兼容,会导致崩溃
;opcache.file_cache_only=1

; ========================================
; 内存配置
; ========================================

; OPcache 内存大小 (MB) - 用于存储编译后的 opcode
; 即使设置了 file_cache_only=1,仍需设置,用于内部元数据
opcache.memory_consumption=512

; 字符串驻留缓冲区大小 (MB) - 存储重复的字符串 (类名、函数名等)
; 可以减少内存使用,提升性能
opcache.interned_strings_buffer=64

; 最大缓存文件数量 - vendor 有 13000+ 文件,设置足够大
; 必须是质数,opcache 会自动调整为最接近的质数
opcache.max_accelerated_files=1000000

; ========================================
; 文件缓存优化 (即使未启用 file_cache 也可设置)
; ========================================

; opcache.file_cache_consistency_checks=0
; 禁用文件缓存一致性检查 - 提升性能,假设缓存始终有效
; = 0 表示不检查文件缓存是否损坏
; 建议在稳定环境启用此优化
opcache.file_cache_consistency_checks=0

; ========================================
; 文件变更检测配置
; ========================================

; opcache.validate_timestamps=0
; 禁用时间戳验证 - 不检查文件是否被修改 (因为 vendor 很少变更)
; = 0 表示永不检查文件修改时间,性能最佳
; 注意: composer install/update 后需手动重启服务
opcache.validate_timestamps=0

; opcache.revalidate_freq=86400
; 重新验证频率 (秒) - 多久检查一次文件是否更新
; 即使 validate_timestamps=0,此值也无效
; 保留默认值,因为上面已禁用验证
opcache.revalidate_freq=86400

; opcache.revalidate_path=0
; 禁用路径验证 - 不检查文件路径是否改变
; = 0 表示使用完整路径作为缓存键,更安全
opcache.revalidate_path=0

; opcache.validate_permission=0
; 禁用权限验证 - 不检查文件权限变化
; = 0 表示不检查文件 owner/permission,提升性能
opcache.validate_permission=0

; ========================================
; 性能优化选项
; ========================================

; opcache.save_comments=1
; 保存文档注释 - Laravel 必需配置
; = 0 表示丢弃注释,可减小缓存大小,提升性能
; = 1 表示保留注释 (开发环境必须设为 1,支持反射和注解)
; 注意: Laravel 使用注解和反射,必须设为 1,否则会崩溃!
opcache.save_comments=1

; opcache.enable_file_override=0
; 启用 file_exists/is_file 等函数的缓存优化
; = 0 更安全,避免某些边缘情况的问题
; = 1 可以提升性能,但可能导致文件检测不准确
opcache.enable_file_override=0

; opcache.max_file_size=0
; 最大可缓存文件大小 (字节)
; = 0 表示不限制文件大小 - 所有 PHP 文件都可以被缓存
opcache.max_file_size=0

; opcache.file_update_protection=0
; 文件更新保护时间 (秒) - 防止缓存未完全写入的文件
; = 0 表示不保护 (适合开发环境)
; = 2 建议生产环境设为 2,防止缓存正在更新的文件
; 注意: 设为 0 可以避免某些边缘情况的缓存延迟问题
;opcache.file_update_protection=0

; opcache.use_cwd=0
; 是否使用当前工作目录作为缓存键的一部分
; = 0 使用绝对路径,更可靠
; = 1 使用相对路径,可能导致缓存冲突
opcache.use_cwd=0

; opcache.huge_code_pages=1
; 启用大页内存 (Huge Pages) - Linux 性能优化
; 需要系统支持: echo 1 > /proc/sys/vm/nr_hugepages
; 可以提升内存访问速度,减少 TLB miss
; 注意: Windows 和 macOS 不支持此功能
;opcache.huge_code_pages=1

; ========================================
; 黑名单配置
; ========================================

; opcache.blacklist_filename=/usr/local/etc/php/opcache.blacklist
; 黑名单文件路径 - 指定哪些目录不缓存
; 只缓存 vendor 目录,应用代码 (app/、routes/ 等) 不缓存以便实时生效
opcache.blacklist_filename=/usr/local/etc/php/opcache.blacklist

; ========================================
; 预加载配置 (PHP 7.4+)
; ========================================
; opcache.preload=${APP_BASE_PATH}/preload.php
; 预加载脚本路径 - 在服务启动时预先加载指定的 PHP 文件
; 作用: 可以在服务启动时加载常用的类和函数,提升首次请求性能
; 注意:
; 1. 预加载的文件会常驻内存,修改后需重启服务
; 2. 仅适用于 PHP-FPM 模式,CLI 模式下无效
; 3. Laravel 11+ 提供了官方的 preload 支持
;opcache.preload=${APP_BASE_PATH}/preload.php

; opcache.preload_user=www-data
; 预加载脚本运行用户 - 必须与 PHP-FPM 用户一致
; 注意: 安全考虑,不建议使用 root 用户
;opcache.preload_user=www-data

; ========================================
; 错误日志
; ========================================

; opcache.error_log=${LOG_PATH}/php-opcache-error.log
; OPcache 错误日志路径 - 用于调试 opcache 相关问题
; 记录 opcache 的错误、警告和重启信息
opcache.error_log=/data/app/storage/logs/php-opcache-error.log

; ========================================
; 高级优化选项
; ========================================

; opcache.optimization_level=0x7FFEBFFF
; 优化级别 - 控制 opcache 编译优化的程度 (位掩码)
; 0x7FFEBFFF 表示启用几乎所有优化
; 每个位控制一个优化选项,可以通过位运算自定义
opcache.optimization_level=0x7FFEBFFF

; opcache.fast_shutdown=1
; 快速关闭 - 使用内核的内存管理来释放内存
; = 1 可以提升 PHP 进程关闭速度
; 注意: PHP 7.2+ 此选项已废弃,始终启用快速关闭
opcache.fast_shutdown=1

; opcache.force_restart_timeout=180
; 强制重启超时 (秒) - opcache 重启的最小间隔时间
; 防止频繁重启影响性能
; 如果缓存已满且无法释放空间,会等待此时间后强制重启
opcache.force_restart_timeout=180

; ========================================
; 测试结果总结
; ========================================
; ✅ 所有已启用的配置项均通过测试,服务运行正常
; ❌ opcache.file_cache 相关配置会导致 artisan serve 崩溃,已禁用
; ❌ opcache.jit 在测试中导致性能下降,已禁用
; ❌ opcache.huge_code_pages 需要系统支持,已禁用
; ❌ opcache.preload 仅适用于 PHP-FPM,已禁用
;
; 性能提升: 使用共享内存缓存,vendor 目录访问速度提升约 20%
; 注意事项:
; 1. composer install/update 后需重启容器以清除缓存
; 2. 应用代码 (app/routes/config) 不会被缓存,修改后立即生效
; 3. 如需文件缓存优化,建议改用 Laravel Octane 或 PHP-FPM
; ========================================
