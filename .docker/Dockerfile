ARG BASE_IMAGE=php:8.4.4-cli-alpine3.20


#########################################################################################################
#### 时区
#########################################################################################################
FROM ${BASE_IMAGE} AS tz-builder

RUN apk update && apk add tzdata


#########################################################################################################
#### 运行基础镜像
#########################################################################################################
FROM ${BASE_IMAGE}

ARG SWOOLE_VERSION="v6.0.1"
ARG SWOOLE_HTTP_SERVER_NAME="hz"

ENV APP_BASE_PATH                   /data/app
ENV APP_STORAGE_PATH                ${APP_BASE_PATH}/storage

ENV LOG_PATH                        ${APP_STORAGE_PATH}/logs

ENV LARAVEL_OCTANE                  1
ENV OCTANE_STATE_FILE               ${APP_STORAGE_PATH}/run/octane-server-state.json

COPY --from=tz-builder /usr/share/zoneinfo/Asia/Shanghai /etc/localtime

RUN set -eux; \
    # \
    # Update
    apk update; \
    #
    # Install build dependencies
    apk add --no-cache --virtual .build-deps $PHPIZE_DEPS && docker-php-source extract; \
    #
    # Install Bash
    apk add --no-cache bash; \
    #
    # Install Pcntl
    docker-php-ext-install pcntl; \
    #
    # Install BCMath
    docker-php-ext-install bcmath; \
    #
    # Install PDO_PGSQL
    apk add --no-cache libpq-dev && docker-php-ext-install pdo_pgsql; \
    #
    # Install xhprof ext
    pecl install xhprof && docker-php-ext-enable xhprof; \
    #
    # Install APCU ext
    pecl install apcu && docker-php-ext-enable apcu; \
    #
    # Install GMP
    apk add --no-cache gmp-dev && docker-php-ext-install gmp; \
    #
    # Install Intl
    apk add --no-cache icu-dev && docker-php-ext-install intl; \
    #
    # Install Zend OpCache
    # 说明: 配置 opcache 以优化 PHP 性能,适用于生产环境 (Swoole/Octane)
    # 注意: 以下配置针对 Laravel Octane + Swoole,与 artisan serve 的配置要求不同
    # PHP 8.5+ 默认启用 opcache,无需手动 enable
    if ! php -m | grep -qi opcache; then docker-php-ext-enable opcache; fi; \
    rm -rf /tmp/opcache && mkdir -p /tmp/opcache && chmod -R 0777 /tmp/opcache; \
    rm -rf /usr/local/etc/php/conf.d/*opcache.ini && touch /usr/local/etc/php/conf.d/docker-php-ext-opcache.ini; \
    { \
        echo "zend_extension=opcache ; 加载 opcache 扩展"; \
        echo "opcache.enable=1 ; 启用 opcache"; \
        echo "opcache.enable_cli=1 ; CLI 模式也启用 (适用于 Octane)"; \
        echo ";opcache.jit=1205 ; JIT 优化级别 (PHP 8.0+, 可能降低性能,建议测试后启用)"; \
        echo ";opcache.jit_buffer_size=256M ; JIT 缓冲区大小"; \
        echo "opcache.memory_consumption=512 ; opcache 内存大小 512MB"; \
        echo "opcache.interned_strings_buffer=64 ; 字符串缓冲区 64MB (存储类名/函数名等)"; \
        echo "opcache.max_accelerated_files=1000000 ; 最大缓存文件数 (vendor 有大量文件)"; \
        echo "opcache.validate_timestamps=0 ; 禁用时间戳验证 (生产环境不检查文件修改,性能最佳)"; \
        echo "opcache.revalidate_freq=86400 ; 重新验证频率 (validate_timestamps=0 时无效)"; \
        echo "opcache.revalidate_path=0 ; 禁用路径验证 (使用完整路径)"; \
        echo "opcache.validate_permission=0 ; 禁用权限验证 (提升性能)"; \
        echo "opcache.save_comments=0 ; 不保存注释 (生产环境可禁用,减小缓存大小)"; \
        echo "opcache.enable_file_override=0 ; 禁用 file_exists 等函数的缓存优化 (更安全)"; \
        echo "opcache.max_file_size=0 ; 不限制文件大小"; \
        echo "opcache.file_update_protection=0 ; 文件更新保护时间 0秒 (生产环境建议设为 2)"; \
        echo "opcache.use_cwd=0 ; 使用绝对路径作为缓存键"; \
        echo "opcache.file_cache=/tmp/opcache ; 文件缓存目录 (持久化缓存到磁盘)"; \
        echo "opcache.file_cache_consistency_checks=0 ; 禁用文件缓存一致性检查 (提升性能)"; \
        echo "opcache.huge_code_pages=1 ; 启用大页内存 (Linux 性能优化,需系统支持)"; \
        echo "opcache.preload=${APP_BASE_PATH}/preload.php ; 预加载脚本 (启动时加载常用类, PHP 7.4+)"; \
        echo "opcache.error_log=${LOG_PATH}/php-opcache-error.log ; opcache 错误日志"; \
        echo "opcache.blacklist_filename=/usr/local/etc/php/opcache.blacklist ; 黑名单文件 (指定不缓存的目录)"; \
    } > /usr/local/etc/php/conf.d/docker-php-ext-opcache.ini; \
    # 创建必要的目录和文件 \
    mkdir -p "${APP_BASE_PATH}" "${LOG_PATH}" && echo "<?php " > "${APP_BASE_PATH}/preload.php"; \
    rm -rf /usr/local/etc/php/opcache.blacklist && touch /usr/local/etc/php/opcache.blacklist; \
    # \
    # Install Swoole \
    apk add --no-cache libstdc++ libpq; \
    apk add --no-cache --virtual .build-deps-ext-swoole curl-dev linux-headers openssl-dev pcre-dev pcre2-dev zlib-dev; \
    docker-php-ext-install sockets; \
    mkdir -p /usr/src/php/ext/swoole; \
    curl -sfL https://github.com/swoole/swoole-src/archive/${SWOOLE_VERSION}.tar.gz -o swoole.tar.gz; \
    tar xfz swoole.tar.gz --strip-components=1 -C /usr/src/php/ext/swoole; \
    if [ -n "${SWOOLE_HTTP_SERVER_NAME}" ]; then \
        sed -i "s/#define SW_HTTP_SERVER_SOFTWARE \"swoole-http-server\"/#define SW_HTTP_SERVER_SOFTWARE \"${SWOOLE_HTTP_SERVER_NAME}\"/"  "/usr/src/php/ext/swoole/include/swoole_config.h"; \
    fi; \
    docker-php-ext-configure swoole; \
    docker-php-ext-install -j$(nproc) swoole; \
    rm -f swoole.tar.gz && apk del --no-network .build-deps-ext-swoole;  \
    # \
    # test
    su -s /bin/sh - www-data -c "php -m"; \
    # \
    # Clear \
    docker-php-source delete && pecl clear-cache && apk del --no-network .build-deps; \
    rm -rf "/tmp/opcache/*" "${LOG_PATH}/*" "/tmp/pear/"

WORKDIR ${APP_BASE_PATH}

CMD /usr/local/bin/php \
        -d expose_php="Off" \
        -d variables_order="EGPCS" \
        -d realpath_cache_size="16M" \
        -d realpath_cache_ttl="86400" \
        -d error_reporting="E_ALL" \
        -d error_log="${LOG_PATH}/php-error.log" \
        "${APP_BASE_PATH}/vendor/bin/swoole-server" "${OCTANE_STATE_FILE}"
